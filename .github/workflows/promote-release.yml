name: Promote Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to promote (e.g. 2.2.1-alpha). Leave empty to use latest tag.'
        required: false

permissions:
  contents: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.BOT_TOKEN }}

      - name: Determine Version
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          
          if [ -z "$VERSION" ]; then
            echo "No version provided. Fetching latest tag..."
            VERSION=$(git describe --tags --abbrev=0)
            echo "Found latest tag: $VERSION"
          fi
          
          # Ensure version ends with -alpha
          if [[ "$VERSION" != *"-alpha" ]]; then
            echo "Error: Version to promote ($VERSION) must end with -alpha"
            exit 1
          fi
          
          # Strip 'v' prefix if present for consistency
          CLEAN_VERSION="${VERSION#v}"
          
          # Strip -alpha to get the final version
          FINAL_VERSION="${CLEAN_VERSION%-alpha}"
          
          echo "FINAL_VERSION=$FINAL_VERSION" >> $GITHUB_ENV
          echo "Promoting $VERSION to $FINAL_VERSION"

      - name: Update Manifest
        run: |
          # Update manifest using the shared script (overwrites version, no search-replace)
          python3 .github/scripts/bump_version.py --set-version "${{ env.FINAL_VERSION }}" --write
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add custom_components/smarthub/manifest.json
          git commit -m "chore: promote to ${{ env.FINAL_VERSION }}"
          git push

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ env.FINAL_VERSION }}"
          name: "Release v${{ env.FINAL_VERSION }}"
          prerelease: false
          generate_release_notes: true