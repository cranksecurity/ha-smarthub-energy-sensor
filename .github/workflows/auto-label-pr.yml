name: Auto-Label Pull Request
on:
  pull_request:
    types: [opened, edited]
  pull_request_target:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      target_pr:
        description: 'PR number to label (optional). If empty, uses the PR in the event payload.'
        required: false

jobs:
  auto-label:
    runs-on: ubuntu-latest
    # Prevent duplicate runs: 
    # Only run pull_request_target if it's from a fork.
    # Only run pull_request if it's NOT from a fork.
    if: |
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository) ||
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      github.event_name == 'workflow_dispatch'
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Extract and Apply Labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_TOKEN }}
          script: |
            const inputPr = context.payload.inputs ? context.payload.inputs.target_pr : null;
            const prNumber = inputPr ? parseInt(inputPr, 10) : (context.payload.pull_request ? context.payload.pull_request.number : null);
            
            if (!prNumber) {
              console.error('No PR number found in payload or inputs');
              return;
            }

            let body = '';
            if (inputPr || github.event_name === 'pull_request_target') {
              console.log(`Fetching body for PR #${prNumber} from API...`);
              const { data: pullRequest } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              body = pullRequest.body || '';
            } else {
              body = context.payload.pull_request.body || '';
            }

            const labelsToAdd = [];
            
            if (/-\s*\[x\]\s*.*Breaking Change/i.test(body)) labelsToAdd.push('breaking');
            if (/-\s*\[x\]\s*.*New Feature/i.test(body))     labelsToAdd.push('feature');
            if (/-\s*\[x\]\s*.*Bug Fix/i.test(body))         labelsToAdd.push('bug');
            if (/-\s*\[x\]\s*.*Performance/i.test(body))     labelsToAdd.push('performance');
            if (/-\s*\[x\]\s*.*Maintenance/i.test(body))     labelsToAdd.push('maintenance');
            
            if (labelsToAdd.length > 0) {
              console.log(`Adding labels to PR #${prNumber}: ${labelsToAdd.join(', ')}`);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: labelsToAdd
              });
            } else {
              console.log(`No matching checkboxes found in PR #${prNumber} body.`);
            }